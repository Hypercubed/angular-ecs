/**
 * angular-ecs
 * @version v0.0.3 - 2015-02-28
 * @link https://github.com/Hypercubed/angular-ecs
 * @author Jayson Harshbarger <>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){"use strict";var a=function(){var a={};this.register=function(b,c){return angular.isObject(b)?angular.extend(a,b):a[b]=c,this},this.$get=function(b){return angular.forEach(a,function(c,d){angular.isFunction(c)&&(a[d]=b.invoke(c,null,null,d))}),a}};angular.module("hc.ngEcs",["hc.thirdParty"]).config(["thirdPartyProvider",function(a){a.register("EventEmitter2")}]).factory("Entity",["EventEmitter2","$components",function(a,b){function c(){var a=(new Date).getUTCMilliseconds();return""+e++ +"_"+a}function d(b){return!1==this instanceof d?new d(b):(this._id=b||c(),void(this.$$eventEmitter=new a))}var e=0;return d.prototype.$add=function(a,c){if(!a)throw new Error("Can't add component with undefined key.");if(this[a]&&this.$remove(a),c=angular.isDefined(c)?c:{},"$"===a.charAt(0)||"_"===a.charAt(0))return void(this[a]=c);if(b.hasOwnProperty(a)){var d=b[a];"function"==typeof d?c instanceof d?this[a]=c:(this[a]=new d,angular.extend(this[a],c)):(this[a]=angular.copy(d),angular.extend(this[a],c)),this[a].$parent=this}else this[a]=c;this.$$eventEmitter.emit("add",this,a)},d.prototype.$remove=function(a){delete this[a],"$"!==a.charAt(0)&&"_"!==a.charAt(0)&&this.$$eventEmitter.emit("remove",this,a)},d.prototype.$on=function(){return this.$$eventEmitter.on.apply(this.$$eventEmitter,arguments),this},d.prototype.$off=function(){return this.$$eventEmitter.off.apply(this.$$eventEmitter,arguments),this},d.prototype.$emit=function(){return this.$$eventEmitter.emit.apply(this.$$eventEmitter,arguments),this},d}]).provider("$components",a).provider("$systems",a).provider("$entities",a).service("ngEcs",function(a){return new a}).factory("EcsFactory",function(a,b,c,d,e,f){function g(a){this.components=c,this.systems=d,this.entities=e,this.families={},angular.forEach(d,function(a,b){this.$s(b,a)}),angular.forEach(e,function(a){this.$e(a)}),this.$timer=null,this.$playing=!1,this.$delay=1e3,this.$interval=1,this.$systemsQueue=[],angular.extend(this,a)}function h(a){return a?a.join("::"):"::"}function i(a,b){var c=a.indexOf(b);c>-1&&a.splice(c,1)}function j(a,b){var c=a.indexOf(b);0>c&&a.push(b)}function k(a,b){if(!b)return!0;var c=function(b){return a.hasOwnProperty(b)};return b.every(c)}return g.prototype.constructor=g,g.prototype.$c=function(a,b){this.components[a]=b},g.prototype.$s=function(a,b){this.systems[a]=b,this.$systemsQueue.unshift(b);var c=h(b.$require);b.$family=this.families[c]=this.families[c]||[]},g.prototype.$e=function(a,b){var c=this;"object"==typeof a&&(b=a,a=null);var d=new f(a);return d.$world=this,Array.isArray(b)?angular.forEach(b,function(a){d.$add(a),c.$onComponentAdd(d,a)}):angular.forEach(b,function(a,b){d.$add(b,a),c.$onComponentAdd(d,b)}),d.$on("add",function(a,b){c.$onComponentAdd(a,b)}),d.$on("remove",function(a,b){c.$onComponentRemove(a,b)}),this.entities[d._id]=d,d},g.prototype.$$removeEntity=function(a){a.$world=null,a.$off("add",this.$onComponentAdd),angular.forEach(a,function(b,c){"$"!==c.charAt(0)&&"_"!==c.charAt(0)&&a.$remove(c)}),angular.forEach(this.families,function(b){i(b,a)}),a.$off("remove",this.$onComponentRemove),delete this.entities[a._id]},g.prototype.$onComponentAdd=function(a,b){angular.forEach(this.systems,function(c){c.$require&&c.$require.indexOf(b)<0||k(a,c.$require)&&(c.$addEntity&&c.$addEntity(a),j(c.$family,a))})},g.prototype.$onComponentRemove=function(a,b){angular.forEach(this.systems,function(c){!c.$require||c.$require.indexOf(b)<0||(c.$removeEntity&&c.$removeEntity(a),i(c.$family,a))})},g.prototype.$update=function(a){var b=this;a=angular.isUndefined(a)?b.$interval:a;for(var c,d=this.$systemsQueue.length;d--;)c=this.$systemsQueue[d],c.$update&&c.$family.length>0&&c.$update(a)},g.prototype.$start=function(){function a(){c.$update(c.$interval),c.$timer=b(a,c.$delay)}if(!this.$playing){var c=this;c.$playing=!0,a()}},g.prototype.$stop=function(){this.$playing=!1,this.$timer&&b.cancel(this.$timer)},g})}();